<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<link rel="manifest" href="/manifest.json" />
<title>Codeai</title>
<style>
/* --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ --- */
:root {
  --bg-primary: #080808;      /* Ø£Ø³ÙˆØ¯ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø®Ù„ÙÙŠØ©) */
  --bg-header: #141414;       /* Ø£Ø³ÙˆØ¯ Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ (Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ) */
  --bg-secondary: #2A2A2A;    /* Ø±Ù…Ø§Ø¯ÙŠ (Ø§Ù„Ø£Ø²Ø±Ø§Ø±ØŒ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª) */
  --text-color: #FFFFFF;      /* Ø£Ø¨ÙŠØ¶ (Ø§Ù„Ù†ØµÙˆØµ) */
  --accent-color: #333333;    /* Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ† Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª */
}

html, body {
  height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-primary);
  color: var(--text-color);
}

/* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ --- */
.topbar {
  height: 56px; display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-header);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.menu-btn, .settings-btn {
  width: 44px; height: 44px; border-radius: 10px; border: none;
  background: var(--bg-secondary); /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ */
  color: var(--text-color);
  font-size: 20px; cursor: pointer;
}

.root {
  position: fixed; left: 0; top: 56px; right: 0; bottom: 0;
  display: flex; flex-direction: column;
}

/* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ --- */
.messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 12px;
}

.msg {
  max-width: 80%; padding: 12px 16px; border-radius: 18px;
  word-wrap: break-word; line-height: 1.5;
  font-size: 15px;
  color: var(--text-color);
}

/* --- 2. Ø¹ÙƒØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø§Ø± - Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠÙ…ÙŠÙ†) --- */
.msg.user {
  margin-right: auto;       /* ÙŠØ°Ù‡Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± */
  margin-left: 0;
  background: var(--bg-secondary); /* Ø±Ù…Ø§Ø¯ÙŠ */
  border-bottom-left-radius: 4px;
}

.msg.ai {
  margin-left: auto;        /* ÙŠØ°Ù‡Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† */
  margin-right: 0;
  background: #1a1a1a;      /* Ø£Ø³ÙˆØ¯ Ù…Ù…ÙŠØ² Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ */
  border: 1px solid var(--bg-secondary);
  border-bottom-right-radius: 4px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØºÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.msg pre { background: #000; padding: 10px; border-radius: 8px; overflow-x: auto; margin: 5px 0; border: 1px solid #333; }
.msg code { font-family: monospace; font-size: 13px; color: #e0e0e0; }
.code-placeholder {
  background: #111; border: 1px dashed #555; color: #aaa;
  padding: 8px; border-radius: 6px; font-size: 12px; text-align: center;
  margin-top: 5px;
}

/* --- 4. ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (TextArea) --- */
.input-bar {
  min-height: 70px; 
  display: flex; gap: 10px; align-items: flex-end; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„Ø£Ø³ÙÙ„ */
  padding: 12px 16px;
  background: var(--bg-header);
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠÙƒÙˆÙ† TextArea */
.input-wrapper {
  flex: 1; display: flex; flex-direction: column;
}
.input {
  width: 100%;
  border-radius: 20px;
  padding: 12px 16px;
  border: none;
  background: var(--bg-secondary);
  color: var(--text-color);
  font-size: 16px;
  font-family: inherit;
  resize: none; /* Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ */
  overflow-y: hidden; /* Ù…Ø®ÙÙŠ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ */
  line-height: 20px;
  max-height: 60px; /* Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ (Ø­ÙˆØ§Ù„ÙŠ Ø³Ø·Ø±ÙŠÙ† ÙˆÙ†ØµÙ) */
  box-sizing: border-box;
}
.input:focus { outline: none; background: #3a3a3a; }

.send-btn {
  width: 48px; height: 48px; border-radius: 50%; border: none;
  background: var(--bg-secondary);
  color: var(--text-color);
  font-size: 20px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
}
.send-btn:active { transform: scale(0.95); }

/* --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Settings / Menu) --- */
#menuPanel {
  position: fixed; left: -320px; top: 56px; width: 300px; height: calc(100% - 56px);
  background: var(--bg-header); padding: 12px;
  box-shadow: 2px 0 20px rgba(0,0,0,0.8);
  transition: transform .28s ease; z-index: 60;
  border-right: 1px solid #333;
}
#menuPanel.open { transform: translateX(320px); }

.codezone {
  position: fixed; left: 100%; top: 56px; width: 100%; height: calc(100% - 56px);
  background: var(--bg-primary); transition: transform .32s ease; z-index: 55;
  display: flex; flex-direction: column;
}
.codezone.open { transform: translateX(-100%); }

.codearea {
  flex: 1; padding: 15px; border: none;
  background: #050505; color: #e6eef8;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 14px; line-height: 1.6; resize: none;
}
.codearea:focus { outline: none; }

/* Settings Page */
.settings-page {
  position: fixed; left: 0; top: 56px; right: 0; bottom: 0;
  background: var(--bg-primary); padding: 20px;
  display: none; flex-direction: column; z-index: 70;
}
.settings-page.open { display: flex; }

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ */
.run-fab {
  position: absolute; bottom: 24px; right: 24px;
  width: 60px; height: 60px; border-radius: 16px;
  background: var(--bg-secondary);
  border: 1px solid #444;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  z-index: 10; transition: transform 0.2s;
}
.play-icon {
  border-left: 18px solid var(--text-color);
}

/* Preview Overlay */
.fullscreen-overlay {
  background: #fff; z-index: 200; display: none; flex-direction: column;
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
}
.fullscreen-overlay.active { display: flex; }
.preview-header {
  height: 56px; background: var(--bg-header); display: flex; align-items: center;
  justify-content: space-between; padding: 0 16px; color: var(--text-color);
}
.close-preview-btn {
  background: var(--bg-secondary); border: none; color: var(--text-color);
  padding: 8px 16px; border-radius: 8px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="topbar">
    <button id="menuBtn" class="menu-btn" aria-label="menu">â˜°</button>
    <div class="title" style="font-weight:bold; letter-spacing:1px">CODEAI</div>
    <button id="settingsBtn" class="settings-btn" aria-label="settings">âš™</button>
  </div>

  <div id="menuPanel">
    <h3 style="margin:6px 0 15px 0; color:#888; font-size:14px; text-transform:uppercase">Conversations</h3>
    <div id="convList" style="overflow:auto;max-height:60vh"></div>
    <button id="openSettings" style="margin-top:auto;padding:12px;border-radius:8px;background:var(--bg-secondary);color:var(--text-color);border:none;width:100%">Settings</button>
  </div>

  <div class="root">
    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="input-bar">
      <textarea id="input" class="input" placeholder="Type a message..." rows="1" aria-label="message input"></textarea>
      <button id="sendBtn" class="send-btn" title="Send">â¬†</button>
    </div>
  </div>

  <div id="codezone" class="codezone" aria-hidden="true">
    <div style="height:56px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-header)">
      <div>Project Code</div>
      <button id="closeCodeBtn" class="settings-btn" style="font-size:14px; width:auto; padding:0 15px">Back</button>
    </div>
    <textarea id="codeArea" class="codearea">// Your project code will appear here...</textarea>
    
    <button id="runFab" class="run-fab" title="Run Code">
      <div class="play-icon"></div>
    </button>
  </div>

  <div id="previewOverlay" class="fullscreen-overlay">
    <div class="preview-header">
      <span>Live Preview</span>
      <button id="closePreviewMain" class="close-preview-btn">Close</button>
    </div>
    <iframe id="previewFrame" style="flex:1;border:none;background:#fff"></iframe>
  </div>

  <div id="settingsPage" class="settings-page" aria-hidden="true">
    <h2>Settings</h2>
    <label style="margin-top:14px">Theme (Fixed to Dark):
      <select id="themeSelect" style="background:#333;color:#fff;border:none;padding:5px"><option>Dark</option></select>
    </label>
    <div style="margin-top:auto">
      <button id="saveSettings" style="padding:10px 20px;border-radius:8px;background:var(--bg-secondary);border:none;color:#fff">Save</button>
      <button id="closeSettings" style="padding:10px 20px;border-radius:8px;background:transparent;border:1px solid #555;color:#fff;margin-left:8px">Close</button>
    </div>
  </div>

<script>
const RENDER_SERVER_URL = '';
let convs = JSON.parse(localStorage.getItem('codeai_convs')||'[]');
if(!convs.length){ convs=[{id:Date.now().toString(),title:'New Chat',messages:[],code:'// start'}]; localStorage.setItem('codeai_convs', JSON.stringify(convs)); }
let activeId = convs[0].id;

// --- 3. Ù…Ù†Ø·Ù‚ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø·ÙˆÙŠÙ„ (Marked Custom Renderer) ---
const renderer = new marked.Renderer();
renderer.code = function(code, language) {
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ Ø£Ø·ÙˆÙ„ Ù…Ù† 7 Ø£Ø³Ø·Ø±ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ÙƒÙˆØ¯ Ù…Ø´Ø±ÙˆØ¹ ÙˆÙ†Ø®ÙÙŠÙ‡ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  const lineCount = code.split('\n').length;
  if (lineCount > 7) {
    return `<div class="code-placeholder" onclick="document.getElementById('codezone').classList.add('open')">
              ğŸ“„ Full code sent to Codezone<br>
              <span style="text-decoration:underline;cursor:pointer">Click to view</span>
            </div>`;
  }
  // Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØºÙŠØ±Ø§Ù‹ Ù†Ø¹Ø±Ø¶Ù‡
  return `<pre><code>${code}</code></pre>`;
};
marked.setOptions({ renderer: renderer });

const messagesEl = document.getElementById('messages');
const codeArea = document.getElementById('codeArea'); // ØªØ¹Ø±ÙŠÙ Ù…Ø¨ÙƒØ±

function renderMessages(){
  const conv = convs.find(c=>c.id===activeId);
  messagesEl.innerHTML = '';
  
  conv.messages.forEach(m => {
    const d = document.createElement('div');
    d.className = 'msg ' + (m.role==='user'?'user':'ai');
    if(m.role === 'user') {
      d.textContent = m.text;
    } else {
      d.innerHTML = marked.parse(m.text);
    }
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
  
function saveState(){ localStorage.setItem('codeai_convs', JSON.stringify(convs)); }

// --- 4. Ù…Ù†Ø·Ù‚ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø±Ù† (Auto-expanding Textarea) ---
const inputEl = document.getElementById('input');
inputEl.addEventListener('input', function() {
  this.style.height = 'auto'; // ØªØµÙÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
  
  // Ø¥Ø°Ø§ ØªØ¹Ø¯Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ 60px (Ø­ÙˆØ§Ù„ÙŠ Ø³Ø·Ø±ÙŠÙ†)ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ±
  if(this.scrollHeight > 60) {
      this.style.height = '60px';
      this.style.overflowY = 'auto';
  } else {
      this.style.height = (this.scrollHeight) + 'px';
      this.style.overflowY = 'hidden';
  }
});

async function sendMessage(text){
  if(!text) return;
  isAwaitingFirstChunk = true; 
  isStreaming = true;

  const conv = convs.find(c=>c.id===activeId);
  conv.messages.push({role:'user', text});
  saveState(); renderMessages();
  
  // Loading Bubble
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'loadingIndicator';
  loadingIndicator.className = 'msg ai';
  loadingIndicator.style.color = '#888';
  loadingIndicator.innerHTML = 'Thinking...';
  messagesEl.appendChild(loadingIndicator);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try{
    await fetch(RENDER_SERVER_URL + '/api/chat', { 
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:text, convId:activeId, code:conv.code||''})
    });
  }catch(err){
    conv.messages.push({role:'ai', text:'Offline or Server Error.'});
    saveState(); renderMessages();
  }finally{
    if(loadingIndicator.parentElement) {
      loadingIndicator.parentElement.removeChild(loadingIndicator);
    }
  }
}

document.getElementById('sendBtn').addEventListener('click', ()=> {
  const v = inputEl.value.trim();
  if(!v) return;
  inputEl.value='';
  inputEl.style.height = 'auto'; // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù…
  sendMessage(v);
});
inputEl.addEventListener('keydown', e=> { 
    if(e.key==='Enter' && !e.shiftKey){ 
        e.preventDefault(); document.getElementById('sendBtn').click(); 
    }
});

// UI Logic (Menu, Settings, Gestures)
const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');
menuBtn.addEventListener('click', ()=> menuPanel.classList.toggle('open'));

document.getElementById('openSettings').addEventListener('click', ()=> document.getElementById('settingsPage').classList.add('open'));
document.getElementById('closeSettings').addEventListener('click', ()=> document.getElementById('settingsPage').classList.remove('open'));
document.getElementById('saveSettings').addEventListener('click', ()=> alert('Settings Saved'));

const codezone = document.getElementById('codezone');
let startX = 0;
document.addEventListener('touchstart', e=> startX = e.touches[0].clientX, {passive:true});
document.addEventListener('touchend', e=>{
  const endX = (e.changedTouches[0] && e.changedTouches[0].clientX) || startX;
  if(endX - startX < -80) codezone.classList.add('open');
  if(endX - startX > 80) codezone.classList.remove('open');
}, {passive:true});
document.getElementById('closeCodeBtn').addEventListener('click', ()=> codezone.classList.remove('open'));

// SSE & Code Extraction Logic
let isAwaitingFirstChunk = true;
let isStreaming = true;

if(typeof(EventSource) !== 'undefined'){
  const sse = new EventSource(RENDER_SERVER_URL + '/api/events');
  sse.onmessage = (e) => {
    try {
      const payload = JSON.parse(e.data);
      if(payload.type === 'assistant_message'){
        const conv = convs.find(c => c.id === activeId);
        if (!conv) return;

        if (isAwaitingFirstChunk) {
            const ind = document.getElementById('loadingIndicator');
            if(ind) ind.remove();
            isAwaitingFirstChunk = false;
        }

        if(payload.text === '\n[STREAM COMPLETE]') { isStreaming = false; return; }

        const lastMsg = conv.messages[conv.messages.length - 1];
        if(lastMsg && lastMsg.role === 'ai') {
             lastMsg.text += payload.text;
        } else {
             conv.messages.push({role:'ai', text: payload.text});
        }
        
        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Codezone ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ ---
        // Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØªÙ„ Ø§Ù„ÙƒÙˆØ¯ØŒ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ù†Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒÙˆØ¯
        const updatedMsg = conv.messages[conv.messages.length - 1];
        // Regex Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø·ÙˆÙ„ ÙƒØªÙ„Ø© ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯Ø©
        const codeMatch = updatedMsg.text.match(/```(?:html|css|js|javascript|python)?\s*([\s\S]*?)```/g);
        
        if (codeMatch) {
             // Ù†Ø£Ø®Ø° Ø¢Ø®Ø± Ø¨Ù„ÙˆÙƒ ÙƒÙˆØ¯ ØªÙ… ÙƒØªØ§Ø¨ØªÙ‡ (Ø£Ùˆ Ø§Ù„Ø£ÙƒØ¨Ø±)
             let latestCodeBlock = codeMatch[codeMatch.length -1];
             // ØªÙ†Ø¸ÙŠÙ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù€ Markdown
             let cleanCode = latestCodeBlock.replace(/```(?:html|css|js|javascript|python)?/g, '').replace(/```/g, '').trim();
             
             // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„Ø§Ù‹ (Ù…Ø´Ø±ÙˆØ¹ ÙƒØ§Ù…Ù„)ØŒ Ù†Ø¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù€ codezone
             if(cleanCode.split('\n').length > 5) {
                 codeArea.value = cleanCode;
                 conv.code = cleanCode;
             }
        }

        saveState(); renderMessages();
      }
    } catch(err) { console.error(err); }
  };
}

// Render Conversations List
(function renderConversations(){
  const c = document.getElementById('convList');
  c.innerHTML = '';
  convs.forEach(cv=>{
    const el = document.createElement('div'); 
    el.style.padding='12px'; el.style.borderBottom='1px solid #333'; el.style.cursor='pointer';
    el.textContent=cv.title;
    el.addEventListener('click', ()=> { activeId = cv.id; document.getElementById('codeArea').value = cv.code || ''; renderMessages(); menuPanel.classList.remove('open'); });
    c.appendChild(el);
  });
})();

// Run & Preview Logic
const runFab = document.getElementById('runFab');
const previewOverlay = document.getElementById('previewOverlay');
const closePreviewMain = document.getElementById('closePreviewMain');
const previewFrame = document.getElementById('previewFrame');

runFab.addEventListener('click', () => {
  previewOverlay.classList.add('active');
  previewFrame.srcdoc = document.getElementById('codeArea').value;
});
closePreviewMain.addEventListener('click', () => {
  previewOverlay.classList.remove('active');
  previewFrame.srcdoc = '';
});
</script>
</body>
</html>