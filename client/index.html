<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<link rel="manifest" href="/manifest.json" />
<title>Codeai</title>
<style>
/* --- 1. CSS Variables --- */
:root {
  --bg-primary: #080808;      
  --bg-header: #141414;       
  --bg-secondary: #2A2A2A;    
  --text-color: #FFFFFF;      
  --accent-color: #333333;
  --msg-ai-bg: #1a1a1a;
  --border-color: rgba(255,255,255,0.1);
}

[data-theme="light"] {
  --bg-primary: #FFFFFF;
  --bg-header: #F0F0F0;
  --bg-secondary: #E0E0E0;
  --text-color: #080808;
  --accent-color: #CCCCCC;
  --msg-ai-bg: #F9F9F9;
  --border-color: rgba(0,0,0,0.1);
}

html, body {
  height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-primary);
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
}

/* --- Top Bar --- */
.topbar {
  height: 56px; display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-header);
  border-bottom: 1px solid var(--border-color);
  position: relative; z-index: 100;
}

/* --- TASK 2: Logo Styling --- */
.logo-container {
    display: flex; align-items: center; font-weight: bold; font-size: 18px;
    opacity: 0; transition: opacity 0.3s; /* Hidden initially for welcome screen */
}
.logo-symbol {
    font-family: 'Courier New', Courier, monospace;
    font-size: 28px; /* Much larger < */
    font-weight: 900;
    margin-right: 1px;
    margin-top: -4px; /* Slight adjustment */
    line-height: 1;
}
.logo-text-part { letter-spacing: 1px; }

/* Menu Button (Hamburger) */
.menu-btn {
  width: 44px; height: 44px; border-radius: 10px; border: none;
  background: var(--bg-secondary); color: var(--text-color);
  font-size: 20px; cursor: pointer;
  z-index: 1001; /* Higher than menu panel */
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s;
  position: relative;
}
.menu-btn.active { transform: rotate(-180deg); background: transparent; }

.settings-btn {
  width: 44px; height: 44px; border-radius: 10px; border: none;
  background: var(--bg-secondary); color: var(--text-color);
  font-size: 20px; cursor: pointer;
}

/* --- Main Content Area --- */
.root {
  position: fixed; left: 0; top: 56px; right: 0; bottom: 0;
  display: flex; flex-direction: column;
}

/* --- TASK 5: Welcome Screen --- */
#welcomeScreen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg-primary);
    z-index: 50; /* Behind topbar but above messages initially */
    transition: opacity 0.3s;
}
.welcome-logo { font-size: 50px; font-weight: bold; display: flex; align-items: center; margin-bottom: 10px; }
.welcome-logo span { font-family: 'Courier New', monospace; font-size: 70px; font-weight: 900; margin-right: 5px; }
.welcome-sub { font-size: 16px; opacity: 0.6; font-weight: normal; }
.hidden { display: none !important; }

/* --- Messages --- */
.messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 12px;
  position: relative;
}

.msg {
  max-width: 85%; padding: 12px 16px; border-radius: 18px;
  word-wrap: break-word; line-height: 1.6;
  font-size: 15px;
  color: var(--text-color);
}

.msg.user {
  margin-right: auto; margin-left: 0;
  background: var(--bg-secondary);
  border-bottom-left-radius: 4px;
}

.msg.ai {
  margin-left: auto; margin-right: 0;
  background: var(--msg-ai-bg);
  border: 1px solid var(--border-color);
  border-bottom-right-radius: 4px;
}

/* --- Code Blocks inside Chat (TASK 1) --- */
.msg pre { 
    background: #000; padding: 12px; border-radius: 8px; 
    overflow-x: auto; margin: 8px 0; border: 1px solid #333; 
}
.msg code { font-family: 'Consolas', monospace; font-size: 13px; color: #e0e0e0; }

/* Card for hidden large code */
.code-snippet-card {
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--border-color);
  border-radius: 8px; padding: 10px 14px;
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 8px; cursor: pointer;
  transition: background 0.2s;
}
.code-snippet-card:hover { background: rgba(255,255,255,0.05); }
.csc-icon { font-size: 18px; margin-right: 10px; }
.csc-text { font-size: 13px; opacity: 0.8; font-family: monospace; }

/* --- Input Area --- */
.input-bar {
  min-height: 70px; display: flex; gap: 10px; align-items: flex-end;
  padding: 12px 16px; background: var(--bg-header);
  z-index: 60;
}
.input {
  width: 100%; border-radius: 20px; padding: 12px 16px; border: none;
  background: var(--bg-secondary); color: var(--text-color);
  font-size: 16px; font-family: inherit; resize: none; overflow-y: hidden;
  line-height: 20px; max-height: 120px; box-sizing: border-box;
}
.input:focus { outline: none; }

.send-btn {
  width: 48px; height: 48px; border-radius: 50%; border: none;
  background: var(--bg-secondary); color: var(--text-color);
  font-size: 20px; flex-shrink: 0; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* --- TASK 3: Side Menu (Full Height Overlay) --- */
#menuPanel {
  position: fixed; left: -320px; top: 0; width: 300px; height: 100%; /* Full height */
  background: var(--bg-header); 
  padding: 80px 12px 40px 12px; /* Top padding for close btn space, Bottom for Task 4 */
  box-shadow: 2px 0 20px rgba(0,0,0,0.5);
  transition: transform .3s cubic-bezier(0.25, 1, 0.5, 1);
  z-index: 1000; /* Above topbar (100) */
  border-right: 1px solid var(--border-color);
  display: flex; flex-direction: column;
  box-sizing: border-box;
}
#menuPanel.open { transform: translateX(320px); }

#newChatBtn {
  background: var(--bg-secondary); border: none; 
  color: var(--text-color); font-weight: bold; font-size: 15px;
  text-align: center; padding: 12px; cursor: pointer;
  margin-bottom: 20px; display: block; width: 100%; border-radius: 8px;
}

#convList { flex: 1; overflow-y: auto; margin-bottom: 10px; }

/* TASK 4: Settings button raised */
#openSettings {
    margin-top: auto; padding: 14px; border-radius: 8px;
    background: var(--bg-secondary); color: var(--text-color);
    border: none; width: 100%; font-weight: 500;
}

/* --- TASK 3: Codezone (Full Overlay) --- */
.codezone {
  position: fixed; left: 100%; top: 0; width: 100%; height: 100%; /* Full screen */
  background: var(--bg-primary); transition: transform .32s ease;
  z-index: 1100; /* High z-index */
  display: flex; flex-direction: column;
}
.codezone.open { transform: translateX(-100%); }
.codearea {
  flex: 1; padding: 15px; border: none;
  background: #050505; color: #e6eef8;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 14px; line-height: 1.6; resize: none;
}
.codearea:focus { outline: none; }

/* --- TASK 3: Settings Page (Full Overlay) --- */
.settings-page {
  position: fixed; left: 0; top: 0; right: 0; bottom: 0;
  background: var(--bg-primary); padding: 20px;
  display: none; flex-direction: column; 
  z-index: 1200; /* Highest */
}
.settings-page.open { display: flex; }

.setting-row-btn {
  width: 100%; padding: 18px; margin-bottom: 10px;
  background: var(--bg-secondary); border-radius: 12px;
  color: var(--text-color); border: none; font-size: 16px;
  text-align: left; cursor: pointer;
}

/* Theme Popover */
.popover-options {
  position: absolute; top: 70px; left: 20px;
  background: var(--bg-header); border: 1px solid var(--border-color);
  padding: 8px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  display: none; flex-direction: column; gap: 5px; min-width: 160px; z-index: 1210;
}
.popover-options.show { display: flex; }
.option-item { padding: 10px; border-radius: 8px; cursor: pointer; color: var(--text-color); }
.option-item:hover { background: var(--bg-secondary); }

/* Run Button */
.run-fab {
  position: absolute; bottom: 24px; right: 24px;
  width: 60px; height: 60px; border-radius: 16px;
  background: var(--bg-secondary); border: 1px solid var(--border-color);
  box-shadow: 0 6px 20px rgba(0,0,0,0.6); cursor: pointer; 
  display: flex; align-items: center; justify-content: center; z-index: 10;
}
.play-icon { width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 18px solid var(--text-color); margin-left: 4px; }

/* Preview Overlay */
.fullscreen-overlay {
  background: #fff; z-index: 1300; display: none; flex-direction: column;
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
}
.fullscreen-overlay.active { display: flex; }
.preview-header {
  height: 56px; background: var(--bg-header); display: flex; align-items: center;
  justify-content: space-between; padding: 0 16px; color: var(--text-color); border-bottom: 1px solid var(--border-color);
}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  
  <div id="welcomeScreen">
      <div class="welcome-logo">
          <span>&lt;</span>odeai
      </div>
      <div class="welcome-sub">What can I help you with?</div>
  </div>

  <div class="topbar">
    <button id="menuBtn" class="menu-btn" aria-label="menu">â˜°</button>
    
    <div id="topLogo" class="logo-container">
        <span class="logo-symbol">&lt;</span>
        <span class="logo-text-part">odeai</span>
    </div>
    
    <button id="settingsBtn" class="settings-btn" style="visibility:hidden">âš™</button> 
  </div>

  <div id="menuPanel">
    <button id="newChatBtn">New chat +</button>
    <h3 style="margin:10px 0 5px 0; color:var(--text-color); opacity:0.6; font-size:12px; text-transform:uppercase">Conversations</h3>
    <div id="convList"></div>
    <button id="openSettings">Settings</button>
  </div>

  <div class="root">
    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="input-bar">
      <textarea id="input" class="input" placeholder="Type a message..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" title="Send">â¬†</button>
    </div>
  </div>

  <div id="codezone" class="codezone" aria-hidden="true">
    <div style="height:56px;display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg-header);border-bottom:1px solid var(--border-color)">
      <div style="font-weight:bold">Project Code</div>
      <button id="closeCodeBtn" class="settings-btn" style="font-size:14px; width:auto; padding:0 15px">Back</button>
    </div>
    <textarea id="codeArea" class="codearea">// Your project code will appear here...</textarea>
    <button id="runFab" class="run-fab" title="Run Code">
      <div class="play-icon"></div>
    </button>
  </div>

  <div id="previewOverlay" class="fullscreen-overlay">
    <div class="preview-header">
      <span>Live Preview</span>
      <button id="closePreviewMain" class="settings-btn" style="font-size:14px;width:auto;padding:0 15px;">Close</button>
    </div>
    <iframe id="previewFrame" style="flex:1;border:none;background:#fff"></iframe>
  </div>

  <div id="settingsPage" class="settings-page" aria-hidden="true">
    <h2 style="margin-bottom:30px; margin-top:40px">Settings</h2>
    
    <div style="position:relative;">
        <button id="themeBtn" class="setting-row-btn">Theme</button>
        <div id="themePopover" class="popover-options">
            <div class="option-item" onclick="setTheme('dark')">Dark</div>
            <div class="option-item" onclick="setTheme('light')">Light</div>
        </div>
    </div>

    <div style="margin-top:auto; display:flex; justify-content:center; margin-bottom: 20px;">
      <button id="closeSettings" style="padding:14px 40px; border-radius:30px; background:transparent; border:1px solid var(--border-color); color:var(--text-color); cursor:pointer">Close</button>
    </div>
  </div>

<script>
const RENDER_SERVER_URL = '';
let convs = JSON.parse(localStorage.getItem('codeai_convs')||'[]');
if(!convs.length){ convs=[{id:Date.now().toString(),title:'New Chat',messages:[],code:'// start'}]; localStorage.setItem('codeai_convs', JSON.stringify(convs)); }
let activeId = convs[0].id;

// Theme Init
const currentTheme = localStorage.getItem('codeai_theme') || 'dark';
document.documentElement.setAttribute('data-theme', currentTheme);

// --- TASK 1: Smart Code Rendering ---
const renderer = new marked.Renderer();
renderer.code = function(code, language) {
  const lineCount = code.split('\n').length;
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø£Ø³Ø·Ø±)ØŒ Ù‚Ù… Ø¨Ø¥Ø®ÙØ§Ø¦Ù‡ ÙˆÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø·
  if (lineCount > 5) {
    return `<div class="code-snippet-card" onclick="document.getElementById('codezone').classList.add('open')">
              <div style="display:flex;align-items:center">
                 <span class="csc-icon">ðŸ“„</span>
                 <span class="csc-text">Code sent to Codezone (Click to view)</span>
              </div>
              <span style="font-size:18px;opacity:0.5">â€º</span>
            </div>`;
  }
  // Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØºÙŠØ±Ø§Ù‹ØŒ Ø§Ø¹Ø±Ø¶Ù‡
  return `<pre><code>${code}</code></pre>`;
};
marked.setOptions({ renderer: renderer });

const messagesEl = document.getElementById('messages');
const codeArea = document.getElementById('codeArea');
const inputEl = document.getElementById('input');
const welcomeScreen = document.getElementById('welcomeScreen');
const topLogo = document.getElementById('topLogo');

function setTheme(mode) {
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('codeai_theme', mode);
    document.getElementById('themePopover').classList.remove('show');
}
document.getElementById('themeBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('themePopover').classList.toggle('show');
});
document.addEventListener('click', () => document.getElementById('themePopover').classList.remove('show'));

// --- Message Rendering & Welcome Screen Logic ---
function renderMessages(){
  const conv = convs.find(c=>c.id===activeId);
  messagesEl.innerHTML = '';
  
  // Task 5: Toggle Welcome Screen
  if(conv.messages.length === 0) {
      welcomeScreen.classList.remove('hidden');
      topLogo.style.opacity = '0';
  } else {
      welcomeScreen.classList.add('hidden');
      topLogo.style.opacity = '1';
  }

  conv.messages.forEach(m => {
    const d = document.createElement('div');
    d.className = 'msg ' + (m.role==='user'?'user':'ai');
    if(m.role === 'user') {
      d.textContent = m.text;
    } else {
      d.innerHTML = marked.parse(m.text);
    }
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
  
function saveState(){ localStorage.setItem('codeai_convs', JSON.stringify(convs)); }

inputEl.addEventListener('input', function() {
  this.style.height = 'auto';
  if(this.scrollHeight > 120) {
      this.style.height = '120px'; this.style.overflowY = 'auto';
  } else {
      this.style.height = (this.scrollHeight) + 'px'; this.style.overflowY = 'hidden';
  }
});

async function sendMessage(text){
  if(!text) return;
  
  // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  welcomeScreen.classList.add('hidden');
  topLogo.style.opacity = '1';

  isAwaitingFirstChunk = true; 
  isStreaming = true;

  const conv = convs.find(c=>c.id===activeId);
  if (conv.messages.length === 0) {
      conv.title = text.length > 30 ? text.substring(0, 30) + '...' : text;
      renderConversations();
  }

  conv.messages.push({role:'user', text});
  saveState(); renderMessages();
  
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'loadingIndicator';
  loadingIndicator.className = 'msg ai';
  loadingIndicator.style.color = '#888';
  loadingIndicator.innerHTML = '...';
  messagesEl.appendChild(loadingIndicator);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try{
    await fetch(RENDER_SERVER_URL + '/api/chat', { 
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:text, convId:activeId, code:conv.code||''})
    });
  }catch(err){
    conv.messages.push({role:'ai', text:'Offline or Server Error.'});
    saveState(); renderMessages();
  }finally{
    if(loadingIndicator.parentElement) loadingIndicator.remove();
  }
}

document.getElementById('sendBtn').addEventListener('click', ()=> {
  const v = inputEl.value.trim();
  if(!v) return;
  inputEl.value=''; inputEl.style.height = 'auto';
  sendMessage(v);
});
inputEl.addEventListener('keydown', e=> { 
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('sendBtn').click(); }
});

// --- UI Logic ---
const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');

menuBtn.addEventListener('click', ()=> {
    const isOpen = menuPanel.classList.contains('open');
    if(isOpen) {
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active');
    } else {
        menuPanel.classList.add('open');
        menuBtn.classList.add('active');
    }
});

document.getElementById('newChatBtn').addEventListener('click', () => {
    const newId = Date.now().toString();
    convs.unshift({ id: newId, title: 'New Chat', messages: [], code: '// start' });
    activeId = newId;
    saveState(); renderConversations(); renderMessages();
    menuPanel.classList.remove('open');
    menuBtn.classList.remove('active');
    document.getElementById('codeArea').value = '// start';
});

document.getElementById('openSettings').addEventListener('click', ()=> {
    document.getElementById('settingsPage').classList.add('open');
    menuPanel.classList.remove('open');
    menuBtn.classList.remove('active');
});
document.getElementById('closeSettings').addEventListener('click', ()=> document.getElementById('settingsPage').classList.remove('open'));

const codezone = document.getElementById('codezone');
let startX = 0;
document.addEventListener('touchstart', e=> startX = e.touches[0].clientX, {passive:true});
document.addEventListener('touchend', e=>{
  const endX = (e.changedTouches[0] && e.changedTouches[0].clientX) || startX;
  if(endX - startX < -80) codezone.classList.add('open');
  if(endX - startX > 80) codezone.classList.remove('open');
}, {passive:true});
document.getElementById('closeCodeBtn').addEventListener('click', ()=> codezone.classList.remove('open'));

// --- SSE & Code Logic ---
let isAwaitingFirstChunk = true;
if(typeof(EventSource) !== 'undefined'){
  const sse = new EventSource(RENDER_SERVER_URL + '/api/events');
  sse.onmessage = (e) => {
    try {
      const payload = JSON.parse(e.data);
      if(payload.type === 'assistant_message'){
        const conv = convs.find(c => c.id === activeId);
        if (!conv) return;
        if (isAwaitingFirstChunk) {
            const ind = document.getElementById('loadingIndicator');
            if(ind) ind.remove();
            isAwaitingFirstChunk = false;
        }
        if(payload.text === '\n[STREAM COMPLETE]') return;

        const lastMsg = conv.messages[conv.messages.length - 1];
        if(lastMsg && lastMsg.role === 'ai') { lastMsg.text += payload.text; } 
        else { conv.messages.push({role:'ai', text: payload.text}); }
        
        // Extract code for Codezone
        const updatedMsg = conv.messages[conv.messages.length - 1];
        const codeMatch = updatedMsg.text.match(/```(?:html|css|js|javascript|python)?\s*([\s\S]*?)```/g);
        if (codeMatch) {
             let latestCodeBlock = codeMatch[codeMatch.length -1];
             let cleanCode = latestCodeBlock.replace(/```(?:html|css|js|javascript|python)?/g, '').replace(/```/g, '').trim();
             if(cleanCode.split('\n').length > 5) {
                 codeArea.value = cleanCode;
                 conv.code = cleanCode;
             }
        }
        saveState(); renderMessages();
      }
    } catch(err) { console.error(err); }
  };
}

function renderConversations(){
  const c = document.getElementById('convList');
  c.innerHTML = '';
  convs.forEach(cv=>{
    const el = document.createElement('div'); 
    el.style.padding='14px'; 
    el.style.borderBottom='1px solid var(--border-color)';
    el.style.cursor='pointer'; el.style.color = 'var(--text-color)';
    el.textContent=cv.title;
    el.addEventListener('click', ()=> { 
        activeId = cv.id; document.getElementById('codeArea').value = cv.code || ''; 
        renderMessages(); menuPanel.classList.remove('open'); menuBtn.classList.remove('active');
    });
    c.appendChild(el);
  });
}
renderConversations(); 
renderMessages(); // Initial check for welcome screen

const runFab = document.getElementById('runFab');
const previewOverlay = document.getElementById('previewOverlay');
const closePreviewMain = document.getElementById('closePreviewMain');
const previewFrame = document.getElementById('previewFrame');
runFab.addEventListener('click', () => {
  previewOverlay.classList.add('active');
  previewFrame.srcdoc = document.getElementById('codeArea').value;
});
closePreviewMain.addEventListener('click', () => {
  previewOverlay.classList.remove('active');
  previewFrame.srcdoc = '';
});
</script>
</body>
</html>