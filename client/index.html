<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<link rel="manifest" href="/manifest.json" />
<title>Codeai</title>
<style>
/* --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª --- */
:root {
  /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) */
  --bg-primary: #080808;      
  --bg-header: #141414;       
  --bg-secondary: #2A2A2A;    
  --text-color: #FFFFFF;      
  --accent-color: #333333;
  --msg-ai-bg: #1a1a1a;
  --border-color: rgba(255,255,255,0.1);
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­ (Light Mode) */
[data-theme="light"] {
  --bg-primary: #FFFFFF;      /* Ø¹ÙƒØ³ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù„Ø£Ø¨ÙŠØ¶ */
  --bg-header: #F0F0F0;       /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø´Ø±ÙŠØ· */
  --bg-secondary: #E0E0E0;    /* Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
  --text-color: #080808;      /* Ø§Ù„Ù†Øµ Ø£Ø³ÙˆØ¯ */
  --accent-color: #CCCCCC;
  --msg-ai-bg: #F9F9F9;
  --border-color: rgba(0,0,0,0.1);
}

html, body {
  height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-primary);
  color: var(--text-color);
  transition: background 0.3s, color 0.3s; /* Ù†Ø¹ÙˆÙ…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ… */
}

/* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ --- */
.topbar {
  height: 56px; display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-header);
  border-bottom: 1px solid var(--border-color);
  position: relative; z-index: 100; /* Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø²Ø± ÙÙˆÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
}

/* 2. Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯ÙˆØ±Ø§Ù† */
.menu-btn {
  width: 44px; height: 44px; border-radius: 10px; border: none;
  background: var(--bg-secondary);
  color: var(--text-color);
  font-size: 20px; cursor: pointer;
  z-index: 101; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Ø­Ø±ÙƒØ© Ù†Ø§Ø¹Ù…Ø© */
}

/* Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø°ÙŠ ÙŠØ¶Ø§Ù Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø²Ø± Ø¹ÙƒØ³ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø© */
.menu-btn.active {
  transform: rotate(-180deg);
}

.settings-btn {
  width: 44px; height: 44px; border-radius: 10px; border: none;
  background: var(--bg-secondary);
  color: var(--text-color);
  font-size: 20px; cursor: pointer;
}

.root {
  position: fixed; left: 0; top: 56px; right: 0; bottom: 0;
  display: flex; flex-direction: column;
}

/* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ --- */
.messages {
  flex: 1; overflow-y: auto; padding: 20px;
  display: flex; flex-direction: column; gap: 12px;
}

.msg {
  max-width: 80%; padding: 12px 16px; border-radius: 18px;
  word-wrap: break-word; line-height: 1.5;
  font-size: 15px;
  color: var(--text-color);
}

.msg.user {
  margin-right: auto; margin-left: 0;
  background: var(--bg-secondary);
  border-bottom-left-radius: 4px;
}

.msg.ai {
  margin-left: auto; margin-right: 0;
  background: var(--msg-ai-bg);
  border: 1px solid var(--bg-secondary);
  border-bottom-right-radius: 4px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯ */
.msg pre { background: #000; padding: 10px; border-radius: 8px; overflow-x: auto; margin: 5px 0; border: 1px solid #333; }
.msg code { font-family: monospace; font-size: 13px; color: #e0e0e0; }
.code-placeholder {
  background: #111; border: 1px dashed #555; color: #aaa;
  padding: 8px; border-radius: 6px; font-size: 12px; text-align: center;
  margin-top: 5px;
}

/* --- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ --- */
.input-bar {
  min-height: 70px; display: flex; gap: 10px; align-items: flex-end;
  padding: 12px 16px; background: var(--bg-header);
}
.input {
  width: 100%; border-radius: 20px; padding: 12px 16px; border: none;
  background: var(--bg-secondary); color: var(--text-color);
  font-size: 16px; font-family: inherit; resize: none; overflow-y: hidden;
  line-height: 20px; max-height: 60px; box-sizing: border-box;
}
.input:focus { outline: none; }

.send-btn {
  width: 48px; height: 48px; border-radius: 50%; border: none;
  background: var(--bg-secondary); color: var(--text-color);
  font-size: 20px; flex-shrink: 0; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* --- 3. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Overlay Style) --- */
#menuPanel {
  position: fixed; left: -320px; top: 56px; width: 300px; height: calc(100% - 56px);
  background: var(--bg-header); padding: 12px;
  box-shadow: 2px 0 20px rgba(0,0,0,0.5);
  transition: transform .3s ease; z-index: 90; /* ØªØ­Øª Ø²Ø± Ø§Ù„Ù‡Ø§Ù…Ø¨Ø±ØºØ± */
  border-right: 1px solid var(--border-color);
  display: flex; flex-direction: column;
}
#menuPanel.open { transform: translateX(320px); }

/* Ø²Ø± Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù†ØµÙŠ ÙÙ‚Ø·) */
#newChatBtn {
  background: transparent; border: none; 
  color: var(--text-color); font-weight: bold; font-size: 16px;
  text-align: left; padding: 10px 5px; cursor: pointer;
  margin-bottom: 10px; display: block; width: 100%;
}
#newChatBtn:hover { color: #888; }

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª */
#convList { flex: 1; overflow-y: auto; }

/* Codezone */
.codezone {
  position: fixed; left: 100%; top: 56px; width: 100%; height: calc(100% - 56px);
  background: var(--bg-primary); transition: transform .32s ease; z-index: 95;
  display: flex; flex-direction: column;
}
.codezone.open { transform: translateX(-100%); }
.codearea {
  flex: 1; padding: 15px; border: none;
  background: #050505; color: #e6eef8;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 14px; line-height: 1.6; resize: none;
}
.codearea:focus { outline: none; }

/* --- 5. ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
.settings-page {
  position: fixed; left: 0; top: 56px; right: 0; bottom: 0;
  background: var(--bg-primary); padding: 20px;
  display: none; flex-direction: column; z-index: 200;
}
.settings-page.open { display: flex; }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±ÙŠØ¶Ø© */
.setting-row-btn {
  width: 100%; padding: 18px; margin-bottom: 10px;
  background: var(--bg-secondary); border-radius: 12px;
  color: var(--text-color); border: none; font-size: 16px;
  text-align: left; cursor: pointer; position: relative;
}

/* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„ØµØºÙŠØ±Ø© (Popup) */
.popover-options {
  position: absolute; top: 60px; left: 20px;
  background: var(--bg-header);
  border: 1px solid var(--border-color);
  padding: 8px; border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  display: none; flex-direction: column; gap: 5px; min-width: 150px;
  z-index: 210;
}
.popover-options.show { display: flex; }

.option-item {
  padding: 10px; border-radius: 8px; cursor: pointer;
  color: var(--text-color); text-align: center;
}
.option-item:hover { background: var(--bg-secondary); }
.option-item.selected { background: var(--bg-secondary); font-weight: bold; }

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ */
.run-fab {
  position: absolute; bottom: 24px; right: 24px;
  width: 60px; height: 60px; border-radius: 16px;
  background: var(--bg-secondary);
  border: 1px solid #444;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  z-index: 10;
}
.play-icon { border-left: 18px solid var(--text-color); }

/* Preview Overlay */
.fullscreen-overlay {
  background: #fff; z-index: 300; display: none; flex-direction: column;
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
}
.fullscreen-overlay.active { display: flex; }
.preview-header {
  height: 56px; background: var(--bg-header); display: flex; align-items: center;
  justify-content: space-between; padding: 0 16px; color: var(--text-color);
}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="topbar">
    <button id="menuBtn" class="menu-btn" aria-label="menu">â˜°</button>
    <div class="title" style="font-weight:bold; letter-spacing:1px">&lt;odeai</div>
    <button id="settingsBtn" class="settings-btn" aria-label="settings" style="visibility:hidden">âš™</button> </div>

  <div id="menuPanel">
    <button id="newChatBtn">New chat +</button>
    
    <h3 style="margin:10px 0 5px 0; color:var(--text-color); opacity:0.6; font-size:12px; text-transform:uppercase">Conversations</h3>
    <div id="convList"></div>

    <button id="openSettings" style="margin-top:auto;padding:12px;border-radius:8px;background:var(--bg-secondary);color:var(--text-color);border:none;width:100%">Settings</button>
  </div>

  <div class="root">
    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="input-bar">
      <textarea id="input" class="input" placeholder="Type a message..." rows="1"></textarea>
      <button id="sendBtn" class="send-btn" title="Send">â¬†</button>
    </div>
  </div>

  <div id="codezone" class="codezone" aria-hidden="true">
    <div style="height:56px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-header)">
      <div>Project Code</div>
      <button id="closeCodeBtn" class="settings-btn" style="font-size:14px; width:auto; padding:0 15px">Back</button>
    </div>
    <textarea id="codeArea" class="codearea">// Your project code will appear here...</textarea>
    
    <button id="runFab" class="run-fab" title="Run Code">
      <div class="play-icon"></div>
    </button>
  </div>

  <div id="previewOverlay" class="fullscreen-overlay">
    <div class="preview-header">
      <span>Live Preview</span>
      <button id="closePreviewMain" class="settings-btn" style="font-size:14px;width:auto;padding:0 15px;">Close</button>
    </div>
    <iframe id="previewFrame" style="flex:1;border:none;background:#fff"></iframe>
  </div>

  <div id="settingsPage" class="settings-page" aria-hidden="true">
    <h2 style="margin-bottom:20px;">Settings</h2>
    
    <div style="position:relative;">
        <button id="themeBtn" class="setting-row-btn">Theme</button>
        <div id="themePopover" class="popover-options">
            <div class="option-item" onclick="setTheme('dark')">Dark</div>
            <div class="option-item" onclick="setTheme('light')">Light</div>
        </div>
    </div>

    <div style="margin-top:auto; display:flex; justify-content:center;">
      <button id="closeSettings" style="padding:12px 30px; border-radius:25px; background:transparent; border:1px solid var(--text-color); color:var(--text-color);">Close</button>
    </div>
  </div>

<script>
const RENDER_SERVER_URL = '';
let convs = JSON.parse(localStorage.getItem('codeai_convs')||'[]');
if(!convs.length){ convs=[{id:Date.now().toString(),title:'New Chat',messages:[],code:'// start'}]; localStorage.setItem('codeai_convs', JSON.stringify(convs)); }
let activeId = convs[0].id;

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©
const currentTheme = localStorage.getItem('codeai_theme') || 'dark';
document.documentElement.setAttribute('data-theme', currentTheme);

const renderer = new marked.Renderer();
renderer.code = function(code, language) {
  const lineCount = code.split('\n').length;
  if (lineCount > 7) {
    return `<div class="code-placeholder" onclick="document.getElementById('codezone').classList.add('open')">
              ğŸ“„ Full code sent to Codezone<br>
              <span style="text-decoration:underline;cursor:pointer">Click to view</span>
            </div>`;
  }
  return `<pre><code>${code}</code></pre>`;
};
marked.setOptions({ renderer: renderer });

const messagesEl = document.getElementById('messages');
const codeArea = document.getElementById('codeArea');
const inputEl = document.getElementById('input');

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
function setTheme(mode) {
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('codeai_theme', mode);
    document.getElementById('themePopover').classList.remove('show');
}

// Ø²Ø± Ø§Ù„Ø«ÙŠÙ… ÙŠÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
document.getElementById('themeBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('themePopover').classList.toggle('show');
});
// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', () => {
    document.getElementById('themePopover').classList.remove('show');
});

function renderMessages(){
  const conv = convs.find(c=>c.id===activeId);
  messagesEl.innerHTML = '';
  
  conv.messages.forEach(m => {
    const d = document.createElement('div');
    d.className = 'msg ' + (m.role==='user'?'user':'ai');
    if(m.role === 'user') {
      d.textContent = m.text;
    } else {
      d.innerHTML = marked.parse(m.text);
    }
    messagesEl.appendChild(d);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
  
function saveState(){ localStorage.setItem('codeai_convs', JSON.stringify(convs)); }

// --- ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù€ textarea ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ---
inputEl.addEventListener('input', function() {
  this.style.height = 'auto';
  if(this.scrollHeight > 60) {
      this.style.height = '60px';
      this.style.overflowY = 'auto';
  } else {
      this.style.height = (this.scrollHeight) + 'px';
      this.style.overflowY = 'hidden';
  }
});

async function sendMessage(text){
  if(!text) return;
  isAwaitingFirstChunk = true; 
  isStreaming = true;

  const conv = convs.find(c=>c.id===activeId);
  
  // 4. ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø©
  if (conv.messages.length === 0) {
      conv.title = text.length > 30 ? text.substring(0, 30) + '...' : text;
      renderConversations(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
  }

  conv.messages.push({role:'user', text});
  saveState(); renderMessages();
  
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'loadingIndicator';
  loadingIndicator.className = 'msg ai';
  loadingIndicator.style.color = '#888';
  loadingIndicator.innerHTML = 'Thinking...';
  messagesEl.appendChild(loadingIndicator);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try{
    await fetch(RENDER_SERVER_URL + '/api/chat', { 
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:text, convId:activeId, code:conv.code||''})
    });
  }catch(err){
    conv.messages.push({role:'ai', text:'Offline or Server Error.'});
    saveState(); renderMessages();
  }finally{
    if(loadingIndicator.parentElement) {
      loadingIndicator.parentElement.removeChild(loadingIndicator);
    }
  }
}

document.getElementById('sendBtn').addEventListener('click', ()=> {
  const v = inputEl.value.trim();
  if(!v) return;
  inputEl.value='';
  inputEl.style.height = 'auto';
  sendMessage(v);
});
inputEl.addEventListener('keydown', e=> { 
    if(e.key==='Enter' && !e.shiftKey){ 
        e.preventDefault(); document.getElementById('sendBtn').click(); 
    }
});

// --- UI Logic & Animations ---
const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');

// 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
menuBtn.addEventListener('click', ()=> {
    const isOpen = menuPanel.classList.contains('open');
    if(isOpen) {
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active'); // ÙŠØ¯ÙˆØ± Ù…Ø¹ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø© (ÙŠØ¹ÙˆØ¯ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ)
    } else {
        menuPanel.classList.add('open');
        menuBtn.classList.add('active'); // ÙŠØ¯ÙˆØ± Ø¹ÙƒØ³ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©
    }
});

// 3. Ø²Ø± Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
document.getElementById('newChatBtn').addEventListener('click', () => {
    const newId = Date.now().toString();
    const newConv = { id: newId, title: 'New Chat', messages: [], code: '// start' };
    convs.unshift(newConv); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    activeId = newId;
    saveState();
    renderConversations();
    renderMessages();
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
    menuPanel.classList.remove('open');
    menuBtn.classList.remove('active');
    document.getElementById('codeArea').value = '// start';
});

document.getElementById('openSettings').addEventListener('click', ()=> {
    document.getElementById('settingsPage').classList.add('open');
    menuPanel.classList.remove('open');
    menuBtn.classList.remove('active');
});

document.getElementById('closeSettings').addEventListener('click', ()=> document.getElementById('settingsPage').classList.remove('open'));

const codezone = document.getElementById('codezone');
let startX = 0;
document.addEventListener('touchstart', e=> startX = e.touches[0].clientX, {passive:true});
document.addEventListener('touchend', e=>{
  const endX = (e.changedTouches[0] && e.changedTouches[0].clientX) || startX;
  if(endX - startX < -80) codezone.classList.add('open');
  if(endX - startX > 80) codezone.classList.remove('open');
}, {passive:true});
document.getElementById('closeCodeBtn').addEventListener('click', ()=> codezone.classList.remove('open'));

// SSE & Code Extraction
let isAwaitingFirstChunk = true;
let isStreaming = true;

if(typeof(EventSource) !== 'undefined'){
  const sse = new EventSource(RENDER_SERVER_URL + '/api/events');
  sse.onmessage = (e) => {
    try {
      const payload = JSON.parse(e.data);
      if(payload.type === 'assistant_message'){
        const conv = convs.find(c => c.id === activeId);
        if (!conv) return;

        if (isAwaitingFirstChunk) {
            const ind = document.getElementById('loadingIndicator');
            if(ind) ind.remove();
            isAwaitingFirstChunk = false;
        }

        if(payload.text === '\n[STREAM COMPLETE]') { isStreaming = false; return; }

        const lastMsg = conv.messages[conv.messages.length - 1];
        if(lastMsg && lastMsg.role === 'ai') {
             lastMsg.text += payload.text;
        } else {
             conv.messages.push({role:'ai', text: payload.text});
        }
        
        // Live Code Update
        const updatedMsg = conv.messages[conv.messages.length - 1];
        const codeMatch = updatedMsg.text.match(/```(?:html|css|js|javascript|python)?\s*([\s\S]*?)```/g);
        
        if (codeMatch) {
             let latestCodeBlock = codeMatch[codeMatch.length -1];
             let cleanCode = latestCodeBlock.replace(/```(?:html|css|js|javascript|python)?/g, '').replace(/```/g, '').trim();
             
             if(cleanCode.split('\n').length > 5) {
                 codeArea.value = cleanCode;
                 conv.code = cleanCode;
             }
        }

        saveState(); renderMessages();
      }
    } catch(err) { console.error(err); }
  };
}

function renderConversations(){
  const c = document.getElementById('convList');
  c.innerHTML = '';
  convs.forEach(cv=>{
    const el = document.createElement('div'); 
    el.style.padding='12px'; 
    el.style.borderBottom='1px solid var(--border-color)'; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±
    el.style.cursor='pointer';
    el.style.color = 'var(--text-color)';
    el.textContent=cv.title;
    el.addEventListener('click', ()=> { 
        activeId = cv.id; 
        document.getElementById('codeArea').value = cv.code || ''; 
        renderMessages(); 
        menuPanel.classList.remove('open');
        menuBtn.classList.remove('active');
    });
    c.appendChild(el);
  });
}
renderConversations(); // Initial render

// Run & Preview
const runFab = document.getElementById('runFab');
const previewOverlay = document.getElementById('previewOverlay');
const closePreviewMain = document.getElementById('closePreviewMain');
const previewFrame = document.getElementById('previewFrame');

runFab.addEventListener('click', () => {
  previewOverlay.classList.add('active');
  previewFrame.srcdoc = document.getElementById('codeArea').value;
});
closePreviewMain.addEventListener('click', () => {
  previewOverlay.classList.remove('active');
  previewFrame.srcdoc = '';
});
</script>
</body>
</html>